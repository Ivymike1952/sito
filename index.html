<script>
let ripristinoInCorso = false;
let dataOraSalvata = "";

// Genera hash SHA-256 (16 caratteri)
async function generaHash(input) {
  const encoder = new TextEncoder();
  const data = encoder.encode(input);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 16);
}

async function generaCodice() {
  if (ripristinoInCorso) return;

  const modulo = document.getElementById('myModulo');
  const elementiCheckbox = modulo.querySelectorAll('input[type="checkbox"]');
  const elementiRadio = modulo.querySelectorAll('input[type="radio"]');
  const codice = [];

  elementiCheckbox.forEach(el => { if (el.checked) codice.push(el.value); });
  elementiRadio.forEach(el => { if (el.checked) codice.push(el.value); });

  const discountCode1 = document.getElementById('discount-code1').value.trim();
  const discountCode2 = document.getElementById('discount-code2').value.trim();
  codice.push(discountCode1 || '-');
  codice.push(discountCode2 || '-');

  if (!dataOraSalvata) {
    const now = new Date();
    dataOraSalvata = now.toLocaleString("it-IT");
  }
  codice.push(dataOraSalvata);

  const raw = codice.join('|');
  const codiceStr = await generaHash(raw);

  // Mostra il codice
  document.getElementById('codiceGenerato').innerText = `Codice Generato: ${codiceStr}`;
  document.getElementById('codice').value = codiceStr;
  document.getElementById("quote-date").textContent = dataOraSalvata;

  // --- QUI: invio a GitHub tramite API ---
  // fetch("https://api.github.com/repos/TUO-UTENTE/TUO-REPO/contents/preventivi/preventivo_"+codiceStr+".json", {
  //   method: "PUT",
  //   headers: {
  //     "Authorization": "token TUO_PERSONAL_ACCESS_TOKEN",
  //     "Content-Type": "application/json"
  //   },
  //   body: JSON.stringify({
  //     message: "Aggiunto preventivo " + codiceStr,
  //     content: btoa(unescape(encodeURIComponent(JSON.stringify({ raw }))))
  //   })
  // });
}

async function ripristinaStato() {
  ripristinoInCorso = true;
  const codiceStr = document.getElementById('codice').value.trim();
  if (!codiceStr) {
    alert('Inserisci un codice valido!');
    ripristinoInCorso = false;
    return;
  }

  try {
    const response = await fetch(`https://tuo-utente.github.io/tuo-repo/preventivi/preventivo_${codiceStr}.json`);
    if (!response.ok) throw new Error("File non trovato");
    const data = await response.json();
    const raw = data.raw;
    const valori = raw.split('|');

    const modulo = document.getElementById('myModulo');
    const elementiCheckbox = modulo.querySelectorAll('input[type="checkbox"]');
    const elementiRadio = modulo.querySelectorAll('input[type="radio"]');

    elementiCheckbox.forEach(el => { el.checked = valori.includes(el.value); });
    elementiRadio.forEach(el => { el.checked = valori.includes(el.value); });

    document.getElementById('discount-code1').value = valori[valori.length - 3] !== '-' ? valori[valori.length - 3] : '';
    document.getElementById('discount-code2').value = valori[valori.length - 2] !== '-' ? valori[valori.length - 2] : '';
    dataOraSalvata = valori[valori.length - 1];
    document.getElementById("quote-date").textContent = dataOraSalvata;

    alert('Preventivo ripristinato!');
    document.getElementById('payment-section').classList.remove('disabled-overlay');
  } catch (e) {
    alert('Codice non valido o non trovato!');
  }

  ripristinoInCorso = false;
}
</script>
